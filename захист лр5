from cryptography.hazmat.primitives import hashes, padding
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend
from base64 import b64encode, b64decode
import os


def generate_key(user_data: str) -> bytes:
    digest = hashes.Hash(hashes.SHA256(), backend=default_backend())
    digest.update(user_data.encode('utf-8'))
    return digest.finalize()  

def encrypt_message(message: str, key: bytes) -> str:
    iv = os.urandom(16)  
    padder = padding.PKCS7(128).padder()
    padded_data = padder.update(message.encode('utf-8')) + padder.finalize()

    cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=default_backend())
    encryptor = cipher.encryptor()
    encrypted = encryptor.update(padded_data) + encryptor.finalize()

    return b64encode(iv + encrypted).decode('utf-8')


def decrypt_message(encrypted_b64: str, key: bytes) -> str:
    data = b64decode(encrypted_b64)
    iv = data[:16]
    encrypted = data[16:]

    cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=default_backend())
    decryptor = cipher.decryptor()
    decrypted_padded = decryptor.update(encrypted) + decryptor.finalize()

    unpadder = padding.PKCS7(128).unpadder()
    decrypted = unpadder.update(decrypted_padded) + unpadder.finalize()
    return decrypted.decode('utf-8')


user_info = "IvanPetrenko1995"
email = "ivan.petrenko@gmail.com"
original_message = "Зустрічаємося завтра о 15:00"

key = generate_key(user_info)
encrypted_msg = encrypt_message(original_message, key)
decrypted_msg = decrypt_message(encrypted_msg, key)

# Виведення результатів
print(" Email:", email)
print(" Генерація ключа з:", user_info)
print(" Зашифроване повідомлення:", encrypted_msg)
print(" Розшифроване повідомлення:", decrypted_msg)

